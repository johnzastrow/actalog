name: CI Failure Notify

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  create-issue-on-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Render issue body
        run: |
          cat > /tmp/ci_issue.md <<'EOF'
CI Workflow failure detected

A CI workflow run has failed. Details:

- Workflow: ${{ github.event.workflow_run.name }}
- Run ID: ${{ github.event.workflow_run.id }}
- Branch: ${{ github.event.workflow_run.head_branch }}
- Commit: ${{ github.event.workflow_run.head_commit.id }}
- Conclusion: ${{ github.event.workflow_run.conclusion }}

Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}

Please investigate the failure. If this is intermittent, mark the issue as "flaky" and close when fixed.

--
This issue was created automatically by the CI Failure Notify workflow.
EOF

      - name: Create issue for failed CI run
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "[CI] Workflow failure: ${{ github.event.workflow_run.name }} on ${{ github.event.workflow_run.head_branch }}"
          content-filepath: /tmp/ci_issue.md
          labels: ci,failure,auto
          assignees: ''
